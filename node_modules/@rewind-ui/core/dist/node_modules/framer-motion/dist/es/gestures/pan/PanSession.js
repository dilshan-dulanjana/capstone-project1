import{extractEventInfo as t}from"../../events/event-info.js";import{secondsToMilliseconds as n,millisecondsToSeconds as e}from"../../utils/time-conversion.js";import{addPointerEvent as s}from"../../events/add-pointer-event.js";import{pipe as i}from"../../utils/pipe.js";import{distance2D as o}from"../../utils/distance.js";import{isPrimaryPointer as r}from"../../events/utils/is-primary-pointer.js";import{frame as a,cancelFrame as h,frameData as l}from"../../frameloop/frame.js";class v{constructor(n,e,{transformPagePoint:h}={}){if(this.startEvent=null,this.lastMoveEvent=null,this.lastMoveEventInfo=null,this.handlers={},this.updatePoint=()=>{if(!this.lastMoveEvent||!this.lastMoveEventInfo)return;const t=f(this.lastMoveEventInfo,this.history),n=null!==this.startEvent,e=o(t.offset,{x:0,y:0})>=3;if(!n&&!e)return;const{point:s}=t,{timestamp:i}=l;this.history.push({...s,timestamp:i});const{onStart:r,onMove:a}=this.handlers;n||(r&&r(this.lastMoveEvent,t),this.startEvent=this.lastMoveEvent),a&&a(this.lastMoveEvent,t)},this.handlePointerMove=(t,n)=>{this.lastMoveEvent=t,this.lastMoveEventInfo=m(n,this.transformPagePoint),a.update(this.updatePoint,!0)},this.handlePointerUp=(t,n)=>{if(this.end(),!this.lastMoveEvent||!this.lastMoveEventInfo)return;const{onEnd:e,onSessionEnd:s}=this.handlers,i=f("pointercancel"===t.type?this.lastMoveEventInfo:m(n,this.transformPagePoint),this.history);this.startEvent&&e&&e(t,i),s&&s(t,i)},!r(n))return;this.handlers=e,this.transformPagePoint=h;const v=m(t(n),this.transformPagePoint),{point:p}=v,{timestamp:u}=l;this.history=[{...p,timestamp:u}];const{onSessionStart:d}=e;d&&d(n,f(v,this.history)),this.removeListeners=i(s(window,"pointermove",this.handlePointerMove),s(window,"pointerup",this.handlePointerUp),s(window,"pointercancel",this.handlePointerUp))}updateHandlers(t){this.handlers=t}end(){this.removeListeners&&this.removeListeners(),h(this.updatePoint)}}function m(t,n){return n?{point:n(t.point)}:t}function p(t,n){return{x:t.x-n.x,y:t.y-n.y}}function f({point:t},n){return{point:t,delta:p(t,d(n)),offset:p(t,u(n)),velocity:c(n,.1)}}function u(t){return t[0]}function d(t){return t[t.length-1]}function c(t,s){if(t.length<2)return{x:0,y:0};let i=t.length-1,o=null;const r=d(t);for(;i>=0&&(o=t[i],!(r.timestamp-o.timestamp>n(s)));)i--;if(!o)return{x:0,y:0};const a=e(r.timestamp-o.timestamp);if(0===a)return{x:0,y:0};const h={x:(r.x-o.x)/a,y:(r.y-o.y)/a};return h.x===1/0&&(h.x=0),h.y===1/0&&(h.y=0),h}export{v as PanSession};
