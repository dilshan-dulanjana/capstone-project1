"use strict";var e=require("../../generators/keyframes.cjs"),n=require("../../generators/spring/index.cjs"),t=require("../../generators/inertia.cjs"),r=require("./driver-frameloop.cjs"),l=require("../../../utils/interpolate.cjs"),i=require("../../../utils/clamp.cjs"),a=require("../../../utils/time-conversion.cjs"),s=require("../../generators/utils/calc-duration.cjs");const o={decay:t.inertia,inertia:t.inertia,tween:e.keyframes,keyframes:e.keyframes,spring:n.spring};exports.animateValue=function({autoplay:n=!0,delay:t=0,driver:u=r.frameloopDriver,keyframes:c,type:d="keyframes",repeat:m=0,repeatDelay:p=0,repeatType:f="loop",onPlay:y,onStop:v,onComplete:h,onUpdate:g,...k}){let D,j,q=1,M=!1;const T=()=>{j=new Promise((e=>{D=e}))};let w;T();const x=o[d]||e.keyframes;let S;x!==e.keyframes&&"number"!=typeof c[0]&&(S=l.interpolate([0,100],c,{clamp:!1}),c=[0,100]);const G=x({...k,keyframes:c});let P;"mirror"===f&&(P=x({...k,keyframes:[...c].reverse(),velocity:-(k.velocity||0)}));let b="idle",B=null,C=null,U=null;null===G.calculatedDuration&&m&&(G.calculatedDuration=s.calcGeneratorDuration(G));const{calculatedDuration:V}=G;let z=1/0,A=1/0;null!==V&&(z=V+p,A=z*(m+1)-p);let E=0;const F=e=>{if(null===C)return;q>0&&(C=Math.min(C,e)),q<0&&(C=Math.min(e-A/q,C)),E=null!==B?B:Math.round(e-C)*q;const n=E-t*(q>=0?1:-1),r=q>=0?n<0:n>A;E=Math.max(n,0),"finished"===b&&null===B&&(E=A);let l=E,a=G;if(m){const e=E/z;let n=Math.floor(e),t=e%1;!t&&e>=1&&(t=1),1===t&&n--,n=Math.min(n,m+1);const r=Boolean(n%2);r&&("reverse"===f?(t=1-t,p&&(t-=p/z)):"mirror"===f&&(a=P));let s=i.clamp(0,1,t);E>A&&(s="reverse"===f&&r?1:0),l=s*z}const s=r?{done:!1,value:c[0]}:a.next(l);S&&(s.value=S(s.value));let{done:o}=s;r||null===V||(o=q>=0?E>=A:E<=0);const u=null===B&&("finished"===b||"running"===b&&o);return g&&g(s.value),u&&J(),s},H=()=>{w&&w.stop(),w=void 0},I=()=>{b="idle",H(),D(),T(),C=U=null},J=()=>{b="finished",h&&h(),H(),D()},K=()=>{if(M)return;w||(w=u(F));const e=w.now();y&&y(),null!==B?C=e-B:C&&"finished"!==b||(C=e),"finished"===b&&T(),U=C,B=null,b="running",w.start()};n&&K();const L={then:(e,n)=>j.then(e,n),get time(){return a.millisecondsToSeconds(E)},set time(e){e=a.secondsToMilliseconds(e),E=e,null===B&&w&&0!==q?C=w.now()-e/q:B=e},get duration(){const e=null===G.calculatedDuration?s.calcGeneratorDuration(G):G.calculatedDuration;return a.millisecondsToSeconds(e)},get speed(){return q},set speed(e){e!==q&&w&&(q=e,L.time=a.millisecondsToSeconds(E))},get state(){return b},play:K,pause:()=>{b="paused",B=E},stop:()=>{M=!0,"idle"!==b&&(b="idle",v&&v(),I())},cancel:()=>{null!==U&&F(U),I()},complete:()=>{b="finished"},sample:e=>(C=0,F(e))};return L};
