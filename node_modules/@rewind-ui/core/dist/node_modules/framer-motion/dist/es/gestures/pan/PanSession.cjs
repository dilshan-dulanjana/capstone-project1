"use strict";var t=require("../../events/event-info.cjs"),e=require("../../utils/time-conversion.cjs"),n=require("../../events/add-pointer-event.cjs"),s=require("../../utils/pipe.cjs"),i=require("../../utils/distance.cjs"),o=require("../../events/utils/is-primary-pointer.cjs"),r=require("../../frameloop/frame.cjs");function a(t,e){return e?{point:e(t.point)}:t}function h(t,e){return{x:t.x-e.x,y:t.y-e.y}}function l({point:t},e){return{point:t,delta:h(t,u(e)),offset:h(t,v(e)),velocity:c(e,.1)}}function v(t){return t[0]}function u(t){return t[t.length-1]}function c(t,n){if(t.length<2)return{x:0,y:0};let s=t.length-1,i=null;const o=u(t);for(;s>=0&&(i=t[s],!(o.timestamp-i.timestamp>e.secondsToMilliseconds(n)));)s--;if(!i)return{x:0,y:0};const r=e.millisecondsToSeconds(o.timestamp-i.timestamp);if(0===r)return{x:0,y:0};const a={x:(o.x-i.x)/r,y:(o.y-i.y)/r};return a.x===1/0&&(a.x=0),a.y===1/0&&(a.y=0),a}exports.PanSession=class{constructor(e,h,{transformPagePoint:v}={}){if(this.startEvent=null,this.lastMoveEvent=null,this.lastMoveEventInfo=null,this.handlers={},this.updatePoint=()=>{if(!this.lastMoveEvent||!this.lastMoveEventInfo)return;const t=l(this.lastMoveEventInfo,this.history),e=null!==this.startEvent,n=i.distance2D(t.offset,{x:0,y:0})>=3;if(!e&&!n)return;const{point:s}=t,{timestamp:o}=r.frameData;this.history.push({...s,timestamp:o});const{onStart:a,onMove:h}=this.handlers;e||(a&&a(this.lastMoveEvent,t),this.startEvent=this.lastMoveEvent),h&&h(this.lastMoveEvent,t)},this.handlePointerMove=(t,e)=>{this.lastMoveEvent=t,this.lastMoveEventInfo=a(e,this.transformPagePoint),r.frame.update(this.updatePoint,!0)},this.handlePointerUp=(t,e)=>{if(this.end(),!this.lastMoveEvent||!this.lastMoveEventInfo)return;const{onEnd:n,onSessionEnd:s}=this.handlers,i=l("pointercancel"===t.type?this.lastMoveEventInfo:a(e,this.transformPagePoint),this.history);this.startEvent&&n&&n(t,i),s&&s(t,i)},!o.isPrimaryPointer(e))return;this.handlers=h,this.transformPagePoint=v;const u=a(t.extractEventInfo(e),this.transformPagePoint),{point:c}=u,{timestamp:d}=r.frameData;this.history=[{...c,timestamp:d}];const{onSessionStart:p}=h;p&&p(e,l(u,this.history)),this.removeListeners=s.pipe(n.addPointerEvent(window,"pointermove",this.handlePointerMove),n.addPointerEvent(window,"pointerup",this.handlePointerUp),n.addPointerEvent(window,"pointercancel",this.handlePointerUp))}updateHandlers(t){this.handlers=t}end(){this.removeListeners&&this.removeListeners(),r.cancelFrame(this.updatePoint)}};
