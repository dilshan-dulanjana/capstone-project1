'use client';
import{__rest as e}from"tslib";import{jsx as o,jsxs as a,Fragment as t}from"react/jsx-runtime";import{comboboxReducer as s}from"./combobox.reducer.js";import{ComboboxActionEnum as l}from"./Combobox.types.js";import{ComboboxGroup as i}from"./ComboboxGroup/ComboboxGroup.js";import{ComboboxOption as n}from"./ComboboxOption/ComboboxOption.js";import{useCombobox as r}from"./use-combobox.hook.js";import{useFormControlContext as c}from"../FormControl/FormControl.context.js";import{useInputGroupContext as d}from"../InputGroup/InputGroup.context.js";import p from"../Spinner/Spinner.js";import{useMergeRefs as m,FloatingPortal as u}from"@floating-ui/react";import{useKeypress as h}from"../../hooks/use-keypress.js";import{useVerticalArrows as b}from"../../hooks/use-vertical-arrows.hook.js";import{XMarkIcon as g}from"../../icons/XMark.js";import{useComponentTheme as f}from"../../theme/theme.context.js";import{usePropId as v}from"../../utils/usePropId.js";import{forwardRef as y,useId as O,useReducer as j,useState as x,useRef as C,useEffect as N,useLayoutEffect as w,cloneElement as z}from"react";import{ComboboxContextProvider as I}from"./Combobox.context.js";import{CaretUpDown as k}from"../../icons/CaretUpDown.js";const R={clearable:!0,closeOnEscape:!0,closeOnSelect:!0,color:"dark",disabled:!1,loading:!1,maxHeight:250,minWidth:250,mode:"spacey",multiple:!1,offset:5,optionColor:"gray",radius:"lg",searchable:!0,shadow:"none",size:"md",tone:"light",validation:"none",withRing:!0},E=y(((i,n)=>{var y,E,S,_;const W=f("Combobox"),P=Object.assign(Object.assign(Object.assign(Object.assign({},R),c()),d()),i),{children:B,className:G,clearable:L,closeOnEscape:$,closeOnSelect:A,color:H,controlId:F,initialValue:V,leftIcon:q,loading:D,maxHeight:M,minWidth:T,mode:U,multiple:X,offset:J,onChange:K,onSearch:Q,optionColor:Y,placeholder:Z,radius:ee,searchable:oe,shadow:ae,size:te,tone:se,validation:le,value:ie,withRing:ne}=P,re=e(P,["children","className","clearable","closeOnEscape","closeOnSelect","color","controlId","initialValue","leftIcon","loading","maxHeight","minWidth","mode","multiple","offset","onChange","onSearch","optionColor","placeholder","radius","searchable","shadow","size","tone","validation","value","withRing"]),ce=v(i.id),de=O(),pe=v(F),me=i.disabled||D,ue=!!q,he=!0,[be,ge]=j(s,{multiple:X||!1,initialValue:V,onChange:K,options:[],selectedOptions:[],search:"",searching:!1}),[fe,ve]=x([]),[ye,Oe]=x(""),[je,xe]=x(W.base({className:G,color:H,disabled:me,hasLeftIcon:ue,hasRightIcon:he,radius:ee,shadow:ae,size:te,tone:se,validation:le,withRing:ne})),[Ce,Ne]=x(null),we=C(null),ze=C(null),Ie=C(null),ke={externalSearch:!!Q,mode:U,multiple:X,optionColor:Y,radius:ee,size:te,state:be,dispatch:ge},{x:Re,y:Ee,reference:Se,floating:_e,strategy:We,getFloatingProps:Pe,open:Be,setOpen:Ge}=r({offset:J}),Le=m([Se,we,n||null]),$e=m([ze,_e]),Ae=W.wrapper({disabled:me}),He=W.noResults({size:te}),Fe=q?W.icon({tone:se,size:te,className:q.props.className}):null,Ve=W.leftIconWrapper({size:te}),qe=W.icon({tone:se,size:te}),De=W.rightIconWrapper({color:H,size:te});N((()=>{we.current&&Ne(we.current.getBoundingClientRect().width)}),[]),N((()=>{ie?X&&Array.isArray(ie)&&ie.length>0?ge({type:l.init_multi_select,payload:{values:ie}}):X||"string"!=typeof ie||ge({type:l.single_select,payload:{value:ie}}):ge({type:l.reset,payload:null})}),[ie,X]),N((()=>{var e;Be&&(null===(e=Ie.current)||void 0===e||e.focus()),Ue()}),[Be]),h("Escape",!0,(()=>{ge({type:l.search_reset,payload:null}),Be&&$&&Ge(!1)})),h("Backspace",Be,(()=>{be.search||ge({type:l.remove_last,payload:null})})),h("Enter",!0,(()=>{var e;if(!be.searching)return;const o=null===(e=ze.current)||void 0===e?void 0:e.querySelector('button[aria-hidden="false"]:not([aria-disabled="true"])');o&&o.click()})),w((()=>{setTimeout((()=>{ze.current&&ve(Array.from(ze.current.querySelectorAll('button[aria-hidden="false"][aria-disabled="false"]')))}),1),Ue()}),[be.search]),N((()=>{Be&&A&&Ge(!1)}),[be.selectedOptions]),b(fe,Be);const Me=o("div",Object.assign({className:je},{children:a("div",Object.assign({className:W.tagWrapper({size:te})},{children:[X&&(null===(y=be.selectedOptions)||void 0===y?void 0:y.map(((e,t)=>a("div",Object.assign({className:W.tag({disabled:me,radius:ee,size:te,tone:se})},{children:[o("button",Object.assign({type:"button",disabled:me,"aria-label":`Remove ${e.label}`,className:W.tagButton({color:H,disabled:me}),onClick:o=>{ge({type:l.multi_select,payload:{value:e.value,toggle:!0}}),o.stopPropagation()}},{children:o("span",Object.assign({className:W.tagButtonIcon()},{children:"âœ•"}))})),o("span",{children:e.label})]}),`label-${t}`)))),(!X||Be||0===be.selectedOptions.length)&&o("input",{id:pe,ref:Ie,disabled:me,className:W.input({size:te}),role:"combobox","aria-controls":de,"aria-autocomplete":oe?"both":"list","aria-haspopup":"listbox","aria-expanded":Be,value:be.searching?be.search:(X?"":null===(E=be.selectedOptions[0])||void 0===E?void 0:E.label)||"",placeholder:be.selectedOptions.length?"":Z,readOnly:!oe,autoComplete:"off",onBlur:()=>ge({type:l.search_reset,payload:null}),onChange:e=>{ge({type:l.search_start,payload:{search:e.target.value}}),Q&&Q(e.target.value),Be||Ge(!0)},type:"text"})]}))})),Te="solid"===se?"slate":"gray",Ue=()=>{ze.current&&Oe(W.list({size:te,open:Be,mode:U,radius:ee,shadow:ae}))};return N((()=>{var e,o;if(!(null===(e=we.current)||void 0===e?void 0:e.dataset))return;const a=Object.assign({},null===(o=we.current)||void 0===o?void 0:o.dataset),t=a.hasOwnProperty("hasLeftElement")&&"true"===a.hasLeftElement,s=a.hasOwnProperty("hasRightElement")&&"true"===a.hasRightElement;xe(W.base({className:G,color:H,disabled:me,hasLeftElement:t,hasLeftIcon:ue,hasRightElement:s,hasRightIcon:he,radius:ee,shadow:ae,size:te,tone:se,validation:le,withRing:ne}))}),[G,H,me,ue,he,ee,ae,te,W,se,le,ne]),o(t,{children:a("div",Object.assign({id:ce,ref:Le,className:Ae,onClick:()=>{var e;Be||me||Ge(!0),null===(e=null==Ie?void 0:Ie.current)||void 0===e||e.focus()}},re,{children:[q&&o("span",Object.assign({className:Ve},{children:z(q,{className:Fe})})),Me,D&&o("span",Object.assign({className:De},{children:o(p,{size:te,color:Te})})),!D&&L&&(null===(S=be.selectedOptions)||void 0===S?void 0:S.length)>0&&o("button",Object.assign({"aria-label":"Clear",type:"button",disabled:me,onClick:e=>{ge({type:l.reset,payload:null}),ge({type:l.search_reset,payload:null}),e.stopPropagation()},className:De},{children:o(g,{className:qe})})),!D&&(!L||0===(null===(_=be.selectedOptions)||void 0===_?void 0:_.length))&&o("div",Object.assign({className:De},{children:o(k,{className:qe})})),o(I,Object.assign({value:ke},{children:o(u,{children:a("div",Object.assign({id:de,role:"listbox",ref:$e,className:ye,style:{display:Be?"block":"none",opacity:Be&&!me?1:0,maxHeight:`${M}px`,minWidth:`${T}px`,maxWidth:`${Ce}px`,position:We,top:Ee&&Ee>0&&Ee!==1/0?Ee:0,left:Re||0}},Pe,{children:[0===(null==fe?void 0:fe.length)&&be.searching&&o("div",Object.assign({className:He},{children:"No results"})),B]}))})}))]}))})}));E.displayName="Combobox";const S=Object.assign(E,{Group:i,Option:n});export{S as default};
